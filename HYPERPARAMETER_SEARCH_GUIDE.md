# DynamicFusionModule 超参数搜索指南

## 📋 三阶段搜索策略

```
阶段1: 融合层位置搜索 (小数据)    ← 你现在在这里
    ↓
阶段2: 正则化参数搜索 (中等数据)
    ↓
阶段3: 最终验证 (全数据)
```

---

## 🚀 阶段1：融合层位置搜索

### 目标
快速找到最佳的融合层位置（哪些 ALIGNN 层应该注入文本信息）

### 数据规模
- 训练集：500 样本 (~10% 数据)
- 验证集：50 样本
- 测试集：50 样本
- Epochs：20

### 搜索配置
测试 5 种融合层位置：
1. `"1"` - 早期融合（第1层）
2. `"2"` - 中期融合（第2层）← 你的原始配置
3. `"3"` - 后期融合（第3层）
4. `"2,3"` - 双层融合（第2和第3层）
5. `"1,2,3"` - 全层融合（第1、2、3层）

### 使用方法

#### 方法 A：批量搜索（推荐）⭐

```bash
# 运行所有配置
chmod +x search_fusion_layers.sh
./search_fusion_layers.sh
```

**预计时间**：~1-2 小时（5个配置 × 10-20分钟）

**输出**：
```
./fusion_layer_search/
├── layers_1/           # 配置1的结果
├── layers_2/           # 配置2的结果
├── layers_3/           # 配置3的结果
├── layers_2_3/         # 配置4的结果
├── layers_1_2_3/       # 配置5的结果
└── results_summary.csv # ⭐ 结果汇总
```

#### 方法 B：单个测试

```bash
# 测试单个配置（用于快速验证）
chmod +x test_single_config.sh
./test_single_config.sh "2"        # 测试 layer 2
./test_single_config.sh "2,3"      # 测试 layers 2,3
```

---

## 📊 结果分析

### 自动分析脚本

```bash
# 对比所有配置的结果
python compare_search_results.py --search_dir ./fusion_layer_search/
```

**输出内容**：
1. ✅ 按 MAE 排序的结果表格
2. 📊 性能对比（vs 基线）
3. 🔍 权重比例分析（图/文本）
4. 💡 Top 3 推荐配置
5. 📈 可视化对比图（如果有 matplotlib）

**示例输出**：
```
================================================================================
融合层位置搜索 - 结果汇总
================================================================================

🏆 按验证集 MAE 排序（越小越好):

fusion_layers  best_val_mae  best_test_mae  final_w_graph  final_w_text  ratio
           2,3        0.1234         0.1256         0.6842        0.3158   5.33
             2        0.1256         0.1278         0.6523        0.3477   4.87
             3        0.1289         0.1301         0.7012        0.2988   6.34
         1,2,3        0.1298         0.1312         0.6234        0.3766   4.12
             1        0.1345         0.1367         0.5890        0.4110   3.43

================================================================================
✅ 最佳配置
================================================================================
Fusion Layers:    2,3
验证集 MAE:       0.1234
测试集 MAE:       0.1256
最终 w_graph:     0.6842
最终 w_text:      0.3158
图/文本比例:      5.33x

================================================================================
📊 性能对比
================================================================================

基线配置 (layers=2): MAE = 0.1256
最佳配置 (layers=2,3): MAE = 0.1234
相对提升: +1.75%

================================================================================
🔍 权重比例分析
================================================================================

各配置的图/文本权重比例:

  Layers 2       :  4.87x  ✅ 图占主导
  Layers 2,3     :  5.33x  ✅ 图占主导
  Layers 3       :  6.34x  ✅ 图强主导
  Layers 1,2,3   :  4.12x  ✅ 图占主导
  Layers 1       :  3.43x  ✓ 图偏优

================================================================================
💡 下一步建议
================================================================================

📌 Top 3 配置推荐用于阶段2（中等数据精细调整）:

1. Fusion Layers = 2,3
   验证 MAE: 0.1234
   权重比例: 5.33x

2. Fusion Layers = 2
   验证 MAE: 0.1256
   权重比例: 4.87x

3. Fusion Layers = 3
   验证 MAE: 0.1289
   权重比例: 6.34x

🚀 推荐命令（使用最佳配置）:

# 阶段2: 中等数据精细调整
./fine_tune_search.sh --fusion_layers "2,3"

# 或直接进行完整训练
python train_with_cross_modal_attention.py \
    --use_middle_fusion True \
    --middle_fusion_layers "2,3" \
    --epochs 100 \
    --output_dir ./output_best_config/
```

---

### 手动查看结果

```bash
# 查看汇总 CSV
cat ./fusion_layer_search/results_summary.csv

# 查看特定配置的日志
tail -f ./fusion_layer_search/layers_2/train_*.log

# 查看权重演化
cat ./fusion_layer_search/layers_2/mbj_bandgap/fusion_weights.csv

# 分析权重
python analyze_fusion_weights.py \
    --output_dir ./fusion_layer_search/layers_2/mbj_bandgap/
```

---

## 🎯 如何选择最佳配置

### 判断标准

1. **性能指标**（主要）
   - 验证集 MAE 最低
   - 验证集和测试集 MAE 接近（没过拟合）

2. **权重比例**（辅助）
   - 图/文本比例在 3-10x
   - 过高（>10x）：文本被忽略
   - 过低（<3x）：文本影响过大

3. **稳定性**
   - 训练 loss 收敛平滑
   - 没有剧烈波动

### 决策树

```
MAE 差异 > 5% ?
    ├─ Yes → 选择 MAE 最小的
    └─ No → 查看权重比例
         ├─ 都在 3-10x → 选择简单的（层数少）
         └─ 有的不健康 → 排除，选择健康的
```

---

## 🔧 自定义搜索

### 修改搜索空间

编辑 `search_fusion_layers.sh`：

```bash
# 修改这一行
FUSION_LAYERS_LIST=(
    "1"        # 添加
    "0,1"      # 你想测试的
    "2,3,4"    # 其他配置
)
```

### 修改数据规模

```bash
# 如果想用更多数据（更准确但更慢）
--n_train 1000     # 增加到 1000
--epochs 30        # 增加 epochs
```

### 修改其他参数

```bash
# 同时测试其他参数
--batch_size 128            # 调整批次
--learning_rate 5e-4        # 调整学习率
--middle_fusion_hidden_dim 256  # 调整隐藏维度
```

---

## ⚠️ 常见问题

### Q1: 训练中断了怎么办？

**A**: 脚本会为每个配置创建独立目录，中断的配置重新运行即可：

```bash
# 只测试特定配置
./test_single_config.sh "2,3"
```

### Q2: 所有配置结果都很差？

**可能原因**：
1. 数据集太小（500样本可能不够）
   - **解决**：增加到 `--n_train 1000`

2. Epochs 不够
   - **解决**：增加到 `--epochs 30`

3. 学习率不合适
   - **解决**：试试 `--learning_rate 5e-4` 或 `2e-3`

### Q3: 权重比例都很异常（<2 或 >20）？

**可能原因**：
1. 文本质量问题
   - 检查数据集的文本描述

2. 模型配置问题
   - 调整 `--middle_fusion_hidden_dim`
   - 调整 `--middle_fusion_dropout`

### Q4: 结果差异很小（<1%）？

**这是正常的！**
- 小数据上差异本来就小
- 继续进行阶段2（中等数据）会看到更大差异
- 或直接选择简单配置（层数少）

---

## 📈 预期结果

### 性能提升

| 对比 | 预期提升 |
|------|---------|
| 单层 vs 多层 | 1-5% |
| 随机 vs 最佳 | 5-10% |

### 时间成本

| 方法 | 时间 |
|------|------|
| 5个配置（小数据） | 1-2 小时 |
| 5个配置（中等数据） | 5-10 小时 |
| 5个配置（全数据） | 20-30 小时 |

**节省**: 用小数据先筛选可以节省 80% 时间

---

## 🎓 最佳实践

### DO ✅

1. **先小数据快速筛选**
   - 淘汰明显不好的配置

2. **关注相对排名而非绝对值**
   - 小数据上的 MAE 绝对值不准确
   - 但配置间的相对排名通常是对的

3. **多看权重演化**
   - 确保 w_graph/w_text 比例健康

4. **保留 Top 2-3 配置**
   - 进入下一阶段精细调整

### DON'T ❌

1. **不要只看单个指标**
   - MAE + 权重比例 + 稳定性综合考虑

2. **不要过度优化小数据**
   - 小数据上的最优可能不是全数据最优

3. **不要忽略简单配置**
   - 如果性能接近，选简单的（更快，更稳定）

---

## 🚀 下一步

阶段1完成后：

```bash
# 1. 查看结果
python compare_search_results.py --search_dir ./fusion_layer_search/

# 2. 选择 Top 1-2 配置

# 3. 进行阶段2（精细调整）
# （我们稍后会创建 fine_tune_search.sh）

# 4. 或直接用最佳配置进行完整训练
python train_with_cross_modal_attention.py \
    --use_middle_fusion True \
    --middle_fusion_layers "2,3"  # 替换为你的最佳配置
    --epochs 100 \
    --output_dir ./output_final/
```

---

## 📚 相关文档

- **完整训练示例**: `TRAINING_EXAMPLES.md`
- **快速开始**: `QUICK_START.md`
- **配置分析**: `YOUR_CONFIG_ANALYSIS.md`

---

## 💡 需要帮助？

```bash
# 查看脚本帮助
./search_fusion_layers.sh --help

# 查看单个测试帮助
./test_single_config.sh

# 查看结果分析帮助
python compare_search_results.py --help
```

祝搜索顺利！🎉
